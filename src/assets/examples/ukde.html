<html>
  <head>
    <script src="../js/globals.js"></script>
    <script src="../js/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.13.1/lodash.min.js">
    </script>
    <!-- <<< css -->
    <style>
      html {
        height: 100%;
      }
      body {
        font-family: 'Arial', 'Helvetica', 'sans-serif';
        font-size: 14px;
      }
      textarea {
        width: 100%;
        min-height:200px;
      }
      #buttons {
        margin-top: 10px;
      }
      #buttons > button + button {
        margin-left: 5px;
      }
    </style>
    <!-- >>>> -->
    <!-- <<< javascript -->
    <script type="text/javascript">
      var cfmClient, cfmContent, cfmContentLastSaved
      const ukdeProviderName = 'ukde'
      const ukdeFileType = 'rampgame'

      const _defaultContent = (function () {
        var ans = ""
        function get_default_content () {
          if (ans) return ans // singleton
          if (! cfmClient) return ""
          var new_ans = cfmClient.providers [ukdeProviderName].DefaultContent
          if (! new_ans) return ""
          ans = new_ans
          return ans
        }
        return { get: get_default_content }
      })().get

      function _checkContentChange (content) {
        if (content === undefined) content = getContent ()
        document.getElementById ('save_btn').disabled =
          (content === cfmContent)
        document.getElementById ('open_btn').disabled =
          (cfmContentLastSaved === content)
        _setOpenDefaultBtnState (content)
      }

      function _setOpenDefaultBtnState (content) {
        if (content === undefined) content = getContent ()
        document.getElementById ('open_default_btn').disabled =
           (content === _defaultContent ())
      }

      function connected (client) {
        cfmClient = client
        cfmContent = document.getElementById ("text").value
        cfmContentLastSaved = cfmClient.providers [ukdeProviderName]
          ._lastSavedContent
        document.getElementById ('open_btn').disabled = false
        document.getElementById ('open_default_btn').disabled = false
        document.getElementById ('save_btn').disabled = true
      }

      function focus () {
        document.getElementById ("text").focus ()
      }

      function getContent () {
        return document.getElementById ("text").value
      }

      function openDefaultFile () {
        setContent (_defaultContent ())
      }

      function openFile () {
        cfmClient && cfmClient.openProviderFile ('ukde', ukdeFileType)
      }

      function saveFile () {
        if (! cfmClient) return
        cfmClient.saveFileNoDialog (getContent (), cfmClient.state.metadata)
        // TODO: check whether the content was really saved.
        cfmContent = getContent ()
        cfmContentLastSaved = cfmClient.providers [ukdeProviderName]
          ._lastSavedContent
        _checkContentChange (cfmContent)
      }

      function setContent (_cfmContent) {
        cfmContent = _cfmContent
        document.getElementById ("text").value = cfmContent
        _checkContentChange (cfmContent)
      }
    </script>
    <!-- >>>> -->
  </head>
  <body>
    <!-- <<< body html -->
    <h2>UKDE-CFM Demo</h2>
    <p>
      This simple page demos the workflow of the <tt>ukde</tt> document
      provider of <tt>ukde-cfm</tt>.
      <ul>
        <li>
          The workflow and the nature of <tt>ukde</tt> service demoed and
          explained here are to be <i>hidden</i> from user's view in the
          production version of UKDE.
          <ul>
            Here is the reason.  The <tt>ukde</tt> document provider of
            <tt>ukde-cfm</tt> is designed to serve files when UKDE users
            are playing some demo educational games/activities hosted in
            CODAP while they are still in UKDE website.  In this
            situation, we want the file creation/saving/update mechanism
            to be completely automatic and <i>not</i> to require any
            explicit user action or user awareness of the underlying
            process.
          </ul>
        </li>
        <li>
          A file is created automatically and assigned to a user if user
          starts a CODAP activity in UKDE for the first time.  Each
          distinct CODAP activity hosted in UKDE defines a unique
          &ldquo;file type.&rdquo;
        </li>
        <li>
          User is not allowed to own two or more documents of a given file
          type.  At most one file can be owned by a user per file type.
          If user tries to open the same document in multiple clients, then
          only the first client will be able to run the document.  However,
          later client instances may be given an option to override and take
          over the session (TBD).
        </li>
        <li>
          User document is autosaved whenever <tt>ukde</tt> is notified of
          any change to save.  So, when user logs out of UKDE and logs in
          again later, the activity will continue right where it was left
          off.  (How about an anonymous user?  Give a one-time only
          document?)
          <ul>
            <li>
              In this demo, this autosave mechanism is <i>not</i>
              implemented.  Rather, this demo shows how it recognizes that
              there are saveable changes in the content or not (the "Save"
              button will become clickable, only if there are).  In the
              production software, there will be no "Save" button like in
              this demo and the code will just save the data instead of
              notifying the user to save.
            </li>
            <li>
              Also, in this demo, the changes in content are ephemeral
              between sessions, as the test content below is actually
              <i>not</i> saved in any persistent data base yet.  The changes
              are recognized within a session, but not between sessions.
            </li>
          </ul>
        </li>
        <li>
          User is allowed to reload the default document of a given file type
          (see "Load Default" button below), if user wishes to restart the
          activity from a clean slate.
        </li>
        <li>
          User is not allowed to delete document.  However, as user can
          reload the default document, deleting a document is not really
          necessary.
        </li>
      </ul>
      The file type for this demo is
      &ldquo;<span id=ukde_file_type>--unknown?--</span>.&rdquo;
    </p>
    <div>
      <textarea cols="50" rows="10" id="text"></textarea>
    </div>
    <div id="buttons">
      <button onclick="openFile ()" id=open_btn>Load</button>
      <button onclick="openDefaultFile ()" id=open_default_btn>
         Load Default</button>
      <button onclick="saveFile ()" id=save_btn>Save</button>
    </div>
    <!-- >>>> -->
    <!-- <<< body javascript -->
    <script type="text/javascript">
      var clientOptions = {
        mimeType: "text/plain",
        appName: "CFM_Demo",
        appVersion: "0.1",
        appBuildNum: "1",
        providers: [
         {
          "name": ukdeProviderName,
          "patch": true,
          "ukdeFileType": ukdeFileType // special option for ukde provider
         }
        ],
        ui: {
         newFileOpensInNewTab: false
        }
      }
      CloudFileManager.init (clientOptions)
      CloudFileManager.clientConnect (function (event) {
        console.log (event)
        switch (event.type) {
          case 'connected':
            connected (event.data.client)
            break
          case 'getContent':
            event.callback (getContent ())
            break
          case 'openedFile':
            setContent (event.data.content)
            focus ()
            if (event.callback) event.callback ()
            break
        }
      })
      document.getElementById ("ukde_file_type").innerHTML = '' + ukdeFileType
      ;(function (textarea_id) {
        const w = document.getElementById (textarea_id)
        w.focus ()
        // For some reason, _.debounce will not work well if its first
        // argument is just "_checkContentChange".
        const checkCC = _.debounce (function () {
           _checkContentChange ()
        }, 500)
        for (const event_name of ["input", "keyup", "paste"])
          w.addEventListener (event_name, checkCC)
      })("text")
    </script>
    <!-- >>> -->
  </body>
</html>
