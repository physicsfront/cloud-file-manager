<html>
  <head>
    <script src="../js/globals.js"></script>
    <script src="../js/app.js"></script>
    <style>
      html {
        height: 100%;
      }
      body {
        font-family: 'Arial', 'Helvetica', 'sans-serif';
        font-size: 14px;
      }
      textarea {
        width: 100%;
        min-height:200px;
      }
      #buttons {
        margin-top: 10px;
      }
      #buttons > button + button {
         margin-left: 5px;
      }
    </style>
    <script type="text/javascript">
      var cfmClient, cfmContent;

      // Disable "Expected an assignment or function call and instead saw an expression" warning
      /*jshint -W030 */
      function newFile() {
        cfmClient && cfmClient.newFileDialog();
      }

      function openFile() {
        // no callback for open - we will handle it in the clientInit event callback
        cfmClient && cfmClient.openFileDialog();
      }

      function saveFile() {
        cfmClient && cfmClient.save();
      }

      function saveFileAs() {
        cfmClient && cfmClient.saveFileAsDialog(getContent());
      }

      function getContent() {
        cfmContent = document.getElementById("text").value;
        return cfmContent;
      }

      function setContent(_cfmContent) {
        cfmContent = _cfmContent;
        document.getElementById("text").value = cfmContent;
      }

      function connected(client) {
        cfmClient = client;
        cfmContent = document.getElementById("text").value;
      }

      function changed() {
        cfmClient.dirty();
      }

      function focus() {
        document.getElementById("text").focus();
      }
    </script>
  </head>
  <body>
    <h2>UKDE-CFM Demo</h2>
    <p>
    This simple page demoes the workflow of the <tt>ukde</tt> document
    provider of <tt>ukde-cfm</tt>.
      <ul>
         <li>
            The workflow and the nature of <tt>ukde</tt> service demoed and
            explained here are to be <i>hidden</i> from user's view in the
            production version of UKDE.
            <ul>
               Here is the reason.  The <tt>ukde</tt> document provider of
               <tt>ukde-cfm</tt> is designed to serve files when UKDE users
               are playing some demo educational games/activities hosted in
               CODAP while they are still in UKDE website.  In this
               situation, we want the file creation/saving/update mechanism
               to be completely automatic and <i>not</i> to require any
               explicit user action or user awareness of the underlying
               process.
            </ul>
         </li>
         <li>
            A file is created automatically and assigned to a user if user
            starts a CODAP activity in UKDE for the first time.  Each
            distinct CODAP activity hosted in UKDE defines a unique
            &ldquo;file type.&rdquo;
         </li>
         <li>
            User is not allowed to own two or more documents of a given file
            type.  At most one file can be owned by a user per file type.
         </li>
         <li>
            User document is autosaved whenever <tt>ukde</tt> is notified of
            any change to save.  So, when user logs out of UKDE and logs in
            again later, the activity continues right where it was left off.
            (How about an anonymous user?  Give a one-time only document?)
         </li>
         <li>
            User may be allowed to reload the default document of a given
            file type (see "Load Default" button below), if user wishes to
            restart the activity from a clean slate.
         </li>
         <li>
            User is not allowed to delete document.  However, as user can
            reload the default document, deleting a document is not really
            necessary.
         </li>
      </ul>
      The file type for this demo is &ldquo;rampgame.&rdquo;
    </p>
    <div>
      <textarea cols="50" rows="10" id="text"></textarea>
    </div>
    <div id="buttons">
      <button onclick="openFile()">Load</button>
      <button onclick="newFile()">Load Default</button>
      <button onclick="saveFile()">Save</button>
    </div>
    <script type="text/javascript">
      var clientOptions = {
        mimeType: "text/plain",
        appName: "CFM_Demo",
        appVersion: "0.1",
        appBuildNum: "1",
        providers: [
          {
            "name": "ukde",
            "patch": true
          }
        ]
      };
      CloudFileManager.init(clientOptions);
      CloudFileManager.clientConnect(function (event) {
        console.log(event);
        switch (event.type) {
          case 'connected':
            connected(event.data.client);
            break;

            case 'getContent':
              event.callback(getContent());
              break;

            case 'newedFile':
            case 'openedFile':
              setContent(event.data.content);
              if(event.callback) event.callback();
              focus();
              break;
        }
      });

      document.getElementById("text").focus();
    </script>
  </body>
</html>
