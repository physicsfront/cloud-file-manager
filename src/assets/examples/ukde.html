<html>
  <head>
    <script src="../js/globals.js"></script>
    <script src="../js/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.13.1/lodash.min.js">
    </script>
    <!-- <<< css -->
    <style>
      html {
        height: 100%;
      }
      body {
        font-family: 'Arial', 'Helvetica', 'sans-serif';
        font-size: 14px;
      }
      textarea {
        width: 100%;
        min-height:200px;
      }
      #buttons {
        margin-top: 10px;
      }
      #buttons > button + button {
        margin-left: 5px;
      }
    </style>
    <!-- >>>> -->
    <!-- <<< javascript -->
    <script type="text/javascript">
      var cfmClient, ucfmProvider, cfmFileOpened, cfmContentLastSaved
      var _saving = 0
      const ukdeProviderName = 'ukde'
      const ukdeFileType = 'rampgame'

      function _check_last_save (tmax = 3) {
         if (! _saving) return 0
         var now = (new Date).getTime ()
         if (now - _saving > tmax)
            alert ('The last saving operation did not succeed?!')
         return now
      }

      const _defaultContent = (function () { // singlton function
         var ans = ""
         function get_default_content () {
            if (ans) return ans // singleton (if true value)
            if (! ucfmProvider) return ""
            var new_ans = ucfmProvider.DefaultContent
            if (! new_ans) return ""
            ans = ucfmProvider.standardDOCUCFMJSON (new_ans)
            return ans
         }
         return { get: get_default_content }
      })().get

      function _enableWidgetsOrNot (content) {
         // content, if passed, is trusted as the current content.
         const OK = working ()
         document.getElementById ('text').disabled =
            ! OK || ! cfmFileOpened
         document.getElementById ('close_btn').disabled =
            ! OK || ! cfmFileOpened
         document.getElementById ('open_btn').disabled =
            ! OK || cfmFileOpened
         if (content === undefined && OK) content = getContent ()
         document.getElementById ('open_default_btn').disabled =
            ! OK || content === _defaultContent ()
      }

      function connected (client) {
         cfmClient = client
         ucfmProvider = client.providers [ukdeProviderName]
         _enableWidgetsOrNot ()
      }

      function closeFile () {
         if (! cfmClient) return
         cfmClient.closeFile ()
      }

      function focus () {
         document.getElementById ("text").focus ()
      }

      function getContent () {
         return document.getElementById ("text").value
      }

      function openDefaultFile () {
         cfmFileOpened = true
         setContent (_defaultContent ())
         saveFileIfNeeded ()
         focus ()
      }

      function openFile () {
         if (! cfmClient) return
         cfmClient.openProviderFile (ukdeProviderName, ukdeFileType)
      }

      function saveFileIfNeeded (check_last_save = true) {
         if (! working ()) return
         const curContent = getContent ()
         if (curContent !== cfmContentLastSaved) {
            var now
            if (check_last_save) now = _check_last_save ()
            if (! now)
               now = (new Date).getTime ()
            _saving = now
            cfmClient.saveFileNoDialog (curContent, cfmClient.state.metadata)
            setTimeout (function () { _check_last_save () }, 3300)
         }
      }

      function setContent (cfmContent) {
         document.getElementById ("text").value = cfmContent
         _enableWidgetsOrNot (cfmContent)
      }

      function working () {
         return cfmClient && ucfmProvider && ucfmProvider.working ()
      }
    </script>
    <!-- >>>> -->
  </head>
  <body>
    <!-- <<< body html -->
    <h2>UKDE-CFM Demo</h2>
    <p>
      This simple page demoes the workflow of the <tt>ukde</tt> document
      provider of <tt>ukde-cfm</tt>.
      <ul>
        <li>
          The workflow and the nature of <tt>ukde</tt> service demoed and
          explained here are to be <i>hidden</i> from user's view in the
          production version of UKDE.
          <ul>
            Here is the reason.  The <tt>ukde</tt> document provider of
            <tt>ukde-cfm</tt> is designed to serve files when UKDE users
            are playing some demo educational games/activities hosted in
            CODAP while they are still in UKDE website.  In this
            situation, we want the file creation/saving/update mechanism
            to be completely automatic and <i>not</i> to require any
            explicit user action or user awareness of the underlying
            process.
          </ul>
        </li>
        <li>
          A file is created automatically and assigned to a user if user
          starts a CODAP activity in UKDE for the first time.  Each
          distinct CODAP activity hosted in UKDE defines a unique
          &ldquo;file type.&rdquo;
        </li>
        <li>
          User is not allowed to own two or more documents of a given file
          type.  At most one file can be owned by a user per file type.
          If user tries to open the same document in multiple clients, then
          only the first client will be able to run the document.  However,
          later client instances may be given an option to override and take
          over the session (TBD/TODO).
        </li>
        <li>
          User document is autosaved whenever <tt>ukde</tt> is notified of
          any change to save.  So, when user logs out of UKDE and logs in
          again later, the activity will continue right where it was left
          off.  (How about an anonymous user?  Give a one-time only document?
          However, currently UKDE does not allow anonymous users much
          access to most of its pages.)
        </li>
        <li>
          User is allowed to reload the default document of a given file type
          (see "Load Default" button below), if user wishes to restart the
          activity from a clean slate.
        </li>
        <li>
          User is not allowed to delete document.  However, as user can
          reload the default document, deleting a document is not really
          necessary.
        </li>
      </ul>
      The file type for this demo is
      &ldquo;<span id=ukde_file_type>--unknown?--</span>.&rdquo;
    </p>
    <div>
      <textarea cols="50" rows="24" id="text"></textarea>
    </div>
    <div id="buttons">
      <button onclick="openFile ()" id=open_btn>Open My Document</button>
      <button onclick="openDefaultFile ()" id=open_default_btn>
         Open Default Document</button>
      <button onclick="closeFile ()" id=close_btn>Close My Document</button>
      <!-- TODO: allow taking the ownership of the file. -->
    </div>
    <!-- >>>> -->
    <!-- <<< body javascript -->
    <script type="text/javascript">
      var clientOptions = {
         mimeType: "text/plain",
         appName: "UCFM_Demo",
         appVersion: "0.1",
         appBuildNum: "1",
         providers: [
            {
               name : ukdeProviderName,
               patch : true,
               // special options for ukde provider
               ukdeFileType : ukdeFileType,
               // Opening document as soon as possible ensures well-defined
               // metadata, which is necessary for UCFM to function properly.
               // autoOpen : true, // This is the default.
               originA : "dev", // default is going through all
            }
         ],
         ui: {
            newFileOpensInNewTab: false
         }
      }
      CloudFileManager.init (clientOptions)
      CloudFileManager.clientConnect (function (event) {
         console.log (event)
         switch (event.type) {
          case 'connected':
            connected (event.data.client)
            break
          case 'getContent':
            event.callback (JSON.parse (getContent ()))
            break
          case 'openedFile':
            cfmFileOpened = true
            cfmContentLastSaved = ucfmProvider.standardDOCUCFMJSON
                  (event.data.content)
            setContent (cfmContentLastSaved)
            focus ()
            if (event.callback) event.callback ()
            break
         case 'closedFile':
            cfmFileOpened = false
            cfmContentLastSaved = undefined
            setContent ("")
            break
         case 'savedFile':
            _saving = 0
            cfmContentLastSaved = ucfmProvider.standardDOCUCFMJSON
                  (ucfmProvider.LastSavedContent)
            break
         }
      })
      document.getElementById ("ukde_file_type").innerHTML = '' + ukdeFileType
      ;(function (textarea_id) {
         const w = document.getElementById (textarea_id)
         w.focus ()
         // _.debounce will not work if its first argument is just
         // "_checkContentChange".  Like setTimeout behaves sometimes?
         const checkCC = _.debounce (function () {
            saveFileIfNeeded ()
            _enableWidgetsOrNot ()
         }, 500)
         for (const event_name of ["input", "keyup", "paste"])
            w.addEventListener (event_name, checkCC)
      })("text")
      // does this work?  will see...
      window.addEventListener ("beforeunload", function (event) {
         if (cfmFileOpened) {
            saveFileIfNeeded (false)
            closeFile ()
         }
         return null
      })
    </script>
    <!-- >>> -->
  </body>
</html>
