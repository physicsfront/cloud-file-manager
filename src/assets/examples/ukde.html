<html>
  <head>
    <script src="../js/globals.js"></script>
    <script src="../js/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.13.1/lodash.min.js">
    </script>
    <!-- <<< css -->
    <style>
      html {
        height: 100%;
      }
      body {
        font-family: 'Arial', 'Helvetica', 'sans-serif';
        font-size: 14px;
      }
      textarea {
        width: 100%;
        min-height:200px;
      }
      #buttons {
        margin-top: 10px;
      }
      #buttons > button + button {
        margin-left: 5px;
      }
    </style>
    <!-- >>>> -->
    <!-- <<< javascript -->
    <script type="text/javascript">
      var cfmClient, cfmFileOpened, cfmContentLastSaved
      const ukdeProviderName = 'ukde'
      const ukdeFileType = 'rampgame'

      const _defaultContent = (function () { // singlton function
         var ans = ""
         function get_default_content () {
            if (ans) return ans // singleton (if true value)
            if (! cfmClient) return ""
            const ukdeProvider = cfmClient.providers [ukdeProviderName]
            var new_ans = ukdeProvider.DefaultContent
            if (! new_ans) return ""
            ans = ukdeProvider.standardDOCUCFMJSON (new_ans)
            return ans
         }
         return { get: get_default_content }
      })().get

      function _updateButtonStates (content) {
         document.getElementById ('close_btn').disabled = ! cfmFileOpened
         if (content === undefined) content = getContent ()
         document.getElementById ('open_default_btn').disabled =
            (content === _defaultContent ())
      }

      function connected (client) {
         cfmClient = client
         document.getElementById ('open_default_btn').disabled = false
         document.getElementById ('close_btn').disabled = true
      }

      function closeFile () {
         if (! cfmClient) return
         cfmClient.closeFile ()
      }

      function focus () {
         document.getElementById ("text").focus ()
      }

      function getContent () {
         return document.getElementById ("text").value
      }

      function openDefaultFile () {
         cfmFileOpened = true
         document.getElementById ("text").readOnly = false
         setContent (_defaultContent ())
         saveFileIfNeeded ()
         focus ()
      }

      // This function is no longer in use.  By default, open is automatic in
      // UCFM.
      function openFile () {
         if (! cfmClient) return
         cfmClient.openProviderFile (ukdeProviderName, ukdeFileType)
      }

      function saveFileIfNeeded () {
         if (! cfmClient || ! cfmFileOpened) return
         const curContent = getContent ()
         if (curContent !== cfmContentLastSaved)
            cfmClient.saveFileNoDialog (curContent, cfmClient.state.metadata)
      }

      function setContent (cfmContent) {
         document.getElementById ("text").value = cfmContent
         _updateButtonStates (cfmContent)
      }
    </script>
    <!-- >>>> -->
  </head>
  <body>
    <!-- <<< body html -->
    <h2>UKDE-CFM Demo</h2>
    <p>
      This simple page demoes the workflow of the <tt>ukde</tt> document
      provider of <tt>ukde-cfm</tt>.
      <ul>
        <li>
          The workflow and the nature of <tt>ukde</tt> service demoed and
          explained here are to be <i>hidden</i> from user's view in the
          production version of UKDE.
          <ul>
            Here is the reason.  The <tt>ukde</tt> document provider of
            <tt>ukde-cfm</tt> is designed to serve files when UKDE users
            are playing some demo educational games/activities hosted in
            CODAP while they are still in UKDE website.  In this
            situation, we want the file creation/saving/update mechanism
            to be completely automatic and <i>not</i> to require any
            explicit user action or user awareness of the underlying
            process.
          </ul>
        </li>
        <li>
          A file is created automatically and assigned to a user if user
          starts a CODAP activity in UKDE for the first time.  Each
          distinct CODAP activity hosted in UKDE defines a unique
          &ldquo;file type.&rdquo;
        </li>
        <li>
          User is not allowed to own two or more documents of a given file
          type.  At most one file can be owned by a user per file type.
          If user tries to open the same document in multiple clients, then
          only the first client will be able to run the document.  However,
          later client instances may be given an option to override and take
          over the session (TBD).
        </li>
        <li>
          User document is autosaved whenever <tt>ukde</tt> is notified of
          any change to save.  So, when user logs out of UKDE and logs in
          again later, the activity will continue right where it was left
          off.  (How about an anonymous user?  Give a one-time only
          document?)
          <ul>
            <li>
              In this demo, this autosave mechanism is <i>not</i>
              implemented.  Rather, this demo shows how it recognizes that
              there are saveable changes in the content or not (the "Save"
              button will become clickable, only if there are).  In the
              production software, there will be no "Save" button like in
              this demo and the code will just save the data instead of
              notifying the user to save.
            </li>
            <li>
              Also, in this demo, the changes in content are ephemeral
              between sessions, as the test content below is actually
              <i>not</i> saved in any persistent data base yet.  The changes
              are recognized within a session, but not between sessions.
            </li>
          </ul>
        </li>
        <li>
          User is allowed to reload the default document of a given file type
          (see "Load Default" button below), if user wishes to restart the
          activity from a clean slate.
        </li>
        <li>
          User is not allowed to delete document.  However, as user can
          reload the default document, deleting a document is not really
          necessary.
        </li>
      </ul>
      The file type for this demo is
      &ldquo;<span id=ukde_file_type>--unknown?--</span>.&rdquo;
    </p>
    <div>
      <textarea cols="50" rows="10" id="text"></textarea>
    </div>
    <div id="buttons">
      <button onclick="openDefaultFile ()" id=open_default_btn>
         Open Default</button>
      <button onclick="closeFile ()" id=close_btn>Close My Document</button>
    </div>
    <!-- >>>> -->
    <!-- <<< body javascript -->
    <script type="text/javascript">
      var clientOptions = {
         mimeType: "text/plain",
         appName: "UCFM_Demo",
         appVersion: "0.1",
         appBuildNum: "1",
         providers: [
            {
               name : ukdeProviderName,
               patch : true,
               // special options for ukde provider
               ukdeFileType : ukdeFileType,
               // Opening document as soon as possible ensures well-defined
               // metadata, which is necessary for UCFM to function properly.
               // autoOpen : true, // This is the default.
               originA : "dev", // default is going through all
            }
         ],
         ui: {
            newFileOpensInNewTab: false
         }
      }
      CloudFileManager.init (clientOptions)
      CloudFileManager.clientConnect (function (event) {
         console.log (event)
         switch (event.type) {
          case 'connected':
            connected (event.data.client)
            break
          case 'getContent':
            event.callback (JSON.parse (getContent ()))
            break
          case 'openedFile':
            cfmFileOpened = true
            document.getElementById ("text").readOnly = false
            cfmContentLastSaved = cfmClient.providers [ukdeProviderName]
                  .standardDOCUCFMJSON (event.data.content)
            setContent (cfmContentLastSaved)
            focus ()
            if (event.callback) event.callback ()
            break
         case 'closedFile':
            cfmFileOpened = false
            document.getElementById ("text").readOnly = true
            cfmContentLastSaved = undefined
            setContent ("")
            break
         case 'savedFile':
            const ukdeProvider = cfmClient.providers [ukdeProviderName]
            cfmContentLastSaved = ukdeProvider.standardDOCUCFMJSON (
                  ukdeProvider.LastSavedContent)
            break
         }
      })
      document.getElementById ("ukde_file_type").innerHTML = '' + ukdeFileType
      ;(function (textarea_id) {
         const w = document.getElementById (textarea_id)
         w.focus ()
         // _.debounce will not work if its first argument is just
         // "_checkContentChange".  Like setTimeout behaves sometimes?
         const checkCC = _.debounce (function () {
            saveFileIfNeeded ()
            _updateButtonStates ()
         }, 500)
         for (const event_name of ["input", "keyup", "paste"])
            w.addEventListener (event_name, checkCC)
      })("text")
      document.getElementById ("text").readOnly = true
      window.onbeforeunload = function (event) {
         if (cfmFileOpened) {
            saveFileIfNeeded ()
            closeFile ()
         }
         return null
      }
    </script>
    <!-- >>> -->
  </body>
</html>
