<html>
  <head>
    <script src="../js/globals.js"></script>
    <script src="../js/app.js"></script>
    <style>
      html {
        height: 100%;
      }
      body {
        font-family: 'Arial', 'Helvetica', 'sans-serif';
        font-size: 14px;
      }
      textarea {
        width: 100%;
        min-height:200px;
      }
      #buttons {
        margin-top: 10px;
      }
      #buttons > button + button {
         margin-left: 5px;
      }
    </style>
    <script type="text/javascript">
      var cfmClient, cfmContent;

      // Disable "Expected an assignment or function call and instead saw an expression" warning
      /*jshint -W030 */
      function newFile() {
        cfmClient && cfmClient.newFileDialog();
      }

      function openFile() {
        // no callback for open - we will handle it in the clientInit event callback
        cfmClient && cfmClient.openFileDialog();
      }

      function saveFile() {
        cfmClient && cfmClient.save();
      }

      function saveFileAs() {
        cfmClient && cfmClient.saveFileAsDialog(getContent());
      }

      function getContent() {
        cfmContent = document.getElementById("text").value;
        return cfmContent;
      }

      function setContent(_cfmContent) {
        cfmContent = _cfmContent;
        document.getElementById("text").value = cfmContent;
      }

      function connected(client) {
        cfmClient = client;
        cfmContent = document.getElementById("text").value;
      }

      function changed() {
        cfmClient.dirty();
      }

      function focus() {
        document.getElementById("text").focus();
      }
    </script>
  </head>
  <body>
    <h2>UKDE-CFM Demo App</h2>
    <p>
    This simple demo explicitly shows the workflow of <tt>ukde-cfm</tt> that
    loads and saves codap files in ukde.
      <ul>
         <li>
            The workflow shown here and the underlying file service provided
            by <tt>ukde-cfm</tt> are to be <i>hidden</i> in the production
            version of UKDE.
            <ul>
               <tt>ukde-cfm</tt> is degined to serve files when users of UKDE
               are playing some demo educational games/activities based on
               CODAP while they are visiting the UKDE webiste.  In such a
               situation, we want the file creation/saving/update mechanism
               to be completely automatic and <i>not</i> to require any user
               action or awareness.
            </ul>
         </li>
         <li>
            A file is created automatically and assigned to a user if the
            user starts a CODAP activity for the first time.  The type of
            CODAP activity defines the file type.
         </li>
         <li>
            User is not allowed to own two or more documents for a given file
            type.  At most one file can be owned by a user per file type.
         </li>
         <li>
            User may be allowed to reload the default document of a given
            file type (see "Load Default" button below), to restart the
            activity from a clean slate.
         </li>
         <li>
            User is not allowed to delete the document, once it is created.
            Reloading the default document can be regarded as practically the
            same as &ldquo;deleting the document.&rdquo;  User's activity
            will pick up where it is left off the last time, if user logs
            in again later.
         </li>
      </ul>
      The file type for this demo is &ldquo;rampgame.&rdquo;
    </p>
    <div>
      <textarea cols="50" rows="10" id="text"></textarea>
    </div>
    <div id="buttons">
      <button onclick="openFile()">Load</button>
      <button onclick="newFile()">Load Default</button>
      <button onclick="saveFile()">Save</button>
    </div>
    <script type="text/javascript">
      var clientOptions = {
        mimeType: "text/plain",
        appName: "CFM_Demo",
        appVersion: "0.1",
        appBuildNum: "1",
        providers: [
          {
            "name": "ukde",
            "patch": true
          }
        ]
      };
      CloudFileManager.init(clientOptions);
      CloudFileManager.clientConnect(function (event) {
        console.log(event);
        switch (event.type) {
          case 'connected':
            connected(event.data.client);
            break;

            case 'getContent':
              event.callback(getContent());
              break;

            case 'newedFile':
            case 'openedFile':
              setContent(event.data.content);
              if(event.callback) event.callback();
              focus();
              break;
        }
      });

      document.getElementById("text").focus();
    </script>
  </body>
</html>
